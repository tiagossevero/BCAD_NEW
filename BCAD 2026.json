[
{
  "model": "desktop.document2",
  "pk": 186674,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCAD 01",
    "description": "",
    "uuid": "ac77b155-38fc-5d2b-3fb0-7d3a97b5e331",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 186674, \"uuid\": \"ac77b155-38fc-5d2b-3fb0-7d3a97b5e331\", \"name\": \"BCAD 01\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"cb4210cb-c836-b2d6-2004-d7f17be7732e\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 4: Pipeline SC \\u2192 CPFs \\u2192 bcadastro\\r\\n-- ============================================================================\\r\\n-- VERS\\u00c3O IMPALA - Usando sintaxe correta para explodir arrays\\r\\n-- Sintaxe: FROM tabela t, t.array_column item\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 1: EXTRAIR CPFs DO CADASTRO LOCAL SC (cad_vinculo)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_01_cpfs_socios_sc;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_01_cpfs_socios_sc AS\\r\\nSELECT \\r\\n    v.nu_cnpj_cpf_secund AS cpf_socio,\\r\\n    COUNT(DISTINCT v.nu_cnpj_princ) AS qtd_empresas_sc,\\r\\n    MAX(v.nm_qualificacao) AS exemplo_qualificacao,\\r\\n    MIN(v.dt_inicio_relacao) AS primeira_relacao,\\r\\n    MAX(v.dt_inicio_relacao) AS ultima_relacao\\r\\nFROM \\r\\n    usr_sat_ods.vw_cad_vinculo v\\r\\nWHERE \\r\\n    v.nm_relacao NOT IN ('CONTABILISTA')\\r\\n    AND v.nu_cnpj_cpf_secund IS NOT NULL\\r\\n    AND LENGTH(TRIM(v.nu_cnpj_cpf_secund)) = 11\\r\\n    AND (v.sn_relacao_ativa = 1 \\r\\n         OR v.dt_fim_relacao IS NULL \\r\\n         OR v.dt_fim_relacao >= '2020-01-01')\\r\\nGROUP BY \\r\\n    v.nu_cnpj_cpf_secund\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_01_cpfs_socios_sc;\\r\\n\\r\\n-- Verifica\\u00e7\\u00e3o\\r\\nSELECT 'ETAPA 1: CPFs \\u00fanicos de SC' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_01_cpfs_socios_sc;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 2: EXPLODIR S\\u00d3CIOS DO BCADASTRO E FILTRAR POR CPFs DE SC\\r\\n-- ============================================================================\\r\\n-- Usando sintaxe Impala: FROM tabela t, t.array_column item\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_02_empresas_bcadastro;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_02_empresas_bcadastro AS\\r\\nSELECT DISTINCT\\r\\n    -- Extrair CPF do s\\u00f3cio (padronizar formato)\\r\\n    LPAD(REGEXP_REPLACE(TRIM(CAST(socio.cpfcnpj AS STRING)), '^0+', ''), 11, '0') AS cpf_socio,\\r\\n    m.cnpj AS cnpj_raiz,\\r\\n    m.nomeempresarial AS razao_social,\\r\\n    m.naturezajuridica,\\r\\n    m.porteempresa,\\r\\n    socio.qualificacaosocio,\\r\\n    socio.dataentrada,\\r\\n    -- Dados do estabelecimento\\r\\n    est.cnpj AS cnpj_completo,\\r\\n    est.uf,\\r\\n    est.situacaocadastral,\\r\\n    est.datasituacaocadastral,\\r\\n    est.nomefantasia,\\r\\n    est.cnaefiscal,\\r\\n    -- Dados do Simples Nacional\\r\\n    CASE \\r\\n        WHEN hist_sn.cnpj IS NOT NULL THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS tem_historico_sn,\\r\\n    -- Flag SN: se tem registro na tabela sn, considera que teve/tem SN\\r\\n    CASE \\r\\n        WHEN hist_sn.cnpj IS NOT NULL THEN 1\\r\\n        ELSE 0 \\r\\n    END AS flag_simples_nacional_atual\\r\\nFROM \\r\\n    bcadastro.cnpj_matriz m,\\r\\n    m.socios socio  -- Sintaxe Impala para explodir array\\r\\n-- FILTRO: Apenas CPFs de SC\\r\\nINNER JOIN \\r\\n    gessimples.bcad_01_cpfs_socios_sc cpf_sc \\r\\n    ON LPAD(REGEXP_REPLACE(TRIM(CAST(socio.cpfcnpj AS STRING)), '^0+', ''), 11, '0') = cpf_sc.cpf_socio\\r\\n-- Join com estabelecimento (matriz)\\r\\nLEFT JOIN \\r\\n    bcadastro.cnpj_estabelecimento est \\r\\n    ON SUBSTR(est.cnpj, 1, 8) = m.cnpj \\r\\n    AND est.indicadormatriz = '1'\\r\\n-- Join com hist\\u00f3rico SN\\r\\nLEFT JOIN \\r\\n    bcadastro.sn hist_sn \\r\\n    ON hist_sn.cnpj = m.cnpj\\r\\nWHERE \\r\\n    -- Apenas s\\u00f3cios PF (tipo = 2)\\r\\n    socio.tipo = '2'\\r\\n    AND socio.cpfcnpj IS NOT NULL\\r\\n    AND LENGTH(TRIM(CAST(socio.cpfcnpj AS STRING))) >= 11\\r\\n    -- Excluir empresas baixadas h\\u00e1 muito tempo\\r\\n    AND (est.situacaocadastral IS NULL \\r\\n         OR est.situacaocadastral NOT IN ('08')\\r\\n         OR est.datasituacaocadastral >= '20200101')\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_02_empresas_bcadastro;\\r\\n\\r\\n-- Adicionar respons\\u00e1veis de empresas sem s\\u00f3cios (MEI, EI, etc.)\\r\\nINSERT INTO gessimples.bcad_02_empresas_bcadastro\\r\\nSELECT DISTINCT\\r\\n    LPAD(m.cpfresponsavel, 11, '0') AS cpf_socio,\\r\\n    m.cnpj AS cnpj_raiz,\\r\\n    m.nomeempresarial AS razao_social,\\r\\n    m.naturezajuridica,\\r\\n    m.porteempresa,\\r\\n    m.qualificacaoresponsavel AS qualificacaosocio,\\r\\n    m.datainclusaoresponsavel AS dataentrada,\\r\\n    est.cnpj AS cnpj_completo,\\r\\n    est.uf,\\r\\n    est.situacaocadastral,\\r\\n    est.datasituacaocadastral,\\r\\n    est.nomefantasia,\\r\\n    est.cnaefiscal,\\r\\n    CASE WHEN hist_sn.cnpj IS NOT NULL THEN 1 ELSE 0 END AS tem_historico_sn,\\r\\n    CASE WHEN hist_sn.cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_simples_nacional_atual\\r\\nFROM \\r\\n    bcadastro.cnpj_matriz m\\r\\nINNER JOIN \\r\\n    gessimples.bcad_01_cpfs_socios_sc cpf_sc \\r\\n    ON LPAD(m.cpfresponsavel, 11, '0') = cpf_sc.cpf_socio\\r\\nLEFT JOIN \\r\\n    bcadastro.cnpj_estabelecimento est \\r\\n    ON SUBSTR(est.cnpj, 1, 8) = m.cnpj \\r\\n    AND est.indicadormatriz = '1'\\r\\nLEFT JOIN \\r\\n    bcadastro.sn hist_sn \\r\\n    ON hist_sn.cnpj = m.cnpj\\r\\nWHERE \\r\\n    m.cpfresponsavel IS NOT NULL\\r\\n    AND m.cpfresponsavel != ''\\r\\n    AND LENGTH(TRIM(m.cpfresponsavel)) >= 11\\r\\n    AND (est.situacaocadastral IS NULL \\r\\n         OR est.situacaocadastral NOT IN ('08')\\r\\n         OR est.datasituacaocadastral >= '20200101')\\r\\n    -- Evitar duplicatas (empresas j\\u00e1 inclu\\u00eddas via array de s\\u00f3cios)\\r\\n    AND NOT EXISTS (\\r\\n        SELECT 1 FROM gessimples.bcad_02_empresas_bcadastro b\\r\\n        WHERE b.cpf_socio = LPAD(m.cpfresponsavel, 11, '0')\\r\\n        AND b.cnpj_raiz = m.cnpj\\r\\n    )\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_02_empresas_bcadastro;\\r\\n\\r\\n-- Verifica\\u00e7\\u00e3o\\r\\nSELECT 'ETAPA 2: Empresas bcadastro' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_02_empresas_bcadastro;\\r\\n\\r\\nSELECT 'ETAPA 2: CPFs encontrados' AS etapa, COUNT(DISTINCT cpf_socio) AS qtd \\r\\nFROM gessimples.bcad_02_empresas_bcadastro;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 3: EXTRAIR EMPRESAS SC COM DETALHES\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_03_empresas_sc;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_03_empresas_sc AS\\r\\nSELECT DISTINCT\\r\\n    v.nu_cnpj_cpf_secund AS cpf_socio,\\r\\n    v.nu_cnpj_princ AS cnpj_completo,\\r\\n    SUBSTR(v.nu_cnpj_princ, 1, 8) AS cnpj_raiz,\\r\\n    c.nm_razao_social AS razao_social,\\r\\n    v.nm_qualificacao AS qualificacao,\\r\\n    v.pe_capital_empresa AS perc_participacao,\\r\\n    v.dt_inicio_relacao,\\r\\n    v.dt_fim_relacao,\\r\\n    v.sn_relacao_ativa,\\r\\n    c.nm_reg_apuracao AS regime_tributacao,\\r\\n    c.nm_sit_cadastral AS situacao_cadastral,\\r\\n    c.cd_uf AS uf,\\r\\n    c.nm_munic AS municipio,\\r\\n    CASE \\r\\n        WHEN UPPER(c.nm_reg_apuracao) LIKE '%SIMPLES NACIONAL%' THEN 1 \\r\\n        WHEN c.sn_simples_nacional_rfb = 1 THEN 1\\r\\n        ELSE 0 \\r\\n    END AS flag_simples_nacional,\\r\\n    'SC_LOCAL' AS fonte\\r\\nFROM \\r\\n    usr_sat_ods.vw_cad_vinculo v\\r\\nINNER JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c \\r\\n    ON v.nu_cnpj_princ = c.nu_cnpj\\r\\nINNER JOIN \\r\\n    gessimples.bcad_01_cpfs_socios_sc cpf_sc \\r\\n    ON v.nu_cnpj_cpf_secund = cpf_sc.cpf_socio\\r\\nWHERE \\r\\n    v.nm_relacao NOT IN ('CONTABILISTA')\\r\\n    AND (v.sn_relacao_ativa = 1 \\r\\n         OR v.dt_fim_relacao IS NULL \\r\\n         OR v.dt_fim_relacao >= '2020-01-01')\\r\\n    AND UPPER(c.nm_sit_cadastral) NOT IN ('BAIXADA', 'BAIXA DEFERIDA', 'INAPTA', 'CANCELADO')\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_03_empresas_sc;\\r\\n\\r\\nSELECT 'ETAPA 3: Empresas SC' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_03_empresas_sc;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 4: CONSOLIDAR TODAS AS PARTICIPA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_04_participacoes_todas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_04_participacoes_todas AS\\r\\n-- Empresas de SC (com percentual)\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    cnpj_raiz,\\r\\n    cnpj_completo,\\r\\n    razao_social,\\r\\n    uf,\\r\\n    situacao_cadastral,\\r\\n    qualificacao,\\r\\n    perc_participacao,\\r\\n    flag_simples_nacional,\\r\\n    regime_tributacao,\\r\\n    fonte\\r\\nFROM \\r\\n    gessimples.bcad_03_empresas_sc\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Empresas bcadastro (excluindo duplicatas com SC)\\r\\nSELECT \\r\\n    b.cpf_socio,\\r\\n    b.cnpj_raiz,\\r\\n    b.cnpj_completo,\\r\\n    b.razao_social,\\r\\n    b.uf,\\r\\n    b.situacaocadastral AS situacao_cadastral,\\r\\n    b.qualificacaosocio AS qualificacao,\\r\\n    CAST(NULL AS DOUBLE) AS perc_participacao,\\r\\n    b.flag_simples_nacional_atual AS flag_simples_nacional,\\r\\n    CASE \\r\\n        WHEN b.flag_simples_nacional_atual = 1 THEN 'SIMPLES NACIONAL' \\r\\n        ELSE 'NORMAL' \\r\\n    END AS regime_tributacao,\\r\\n    'BCADASTRO_NACIONAL' AS fonte\\r\\nFROM \\r\\n    gessimples.bcad_02_empresas_bcadastro b\\r\\nWHERE \\r\\n    NOT EXISTS (\\r\\n        SELECT 1 \\r\\n        FROM gessimples.bcad_03_empresas_sc sc \\r\\n        WHERE sc.cnpj_raiz = b.cnpj_raiz\\r\\n          AND sc.cpf_socio = b.cpf_socio\\r\\n    )\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_04_participacoes_todas;\\r\\n\\r\\nSELECT 'ETAPA 4: Total participa\\u00e7\\u00f5es' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_04_participacoes_todas;\\r\\n\\r\\nSELECT fonte, COUNT(*) AS qtd, COUNT(DISTINCT cpf_socio) AS cpfs\\r\\nFROM gessimples.bcad_04_participacoes_todas\\r\\nGROUP BY fonte;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 5: CPFs COM M\\u00daLTIPLAS EMPRESAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_05_cpfs_multiplas_empresas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_05_cpfs_multiplas_empresas AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    COUNT(DISTINCT cnpj_raiz) AS qtd_empresas_total,\\r\\n    COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) AS qtd_empresas_sn,\\r\\n    COUNT(DISTINCT CASE WHEN flag_simples_nacional = 0 THEN cnpj_raiz END) AS qtd_empresas_normal,\\r\\n    MAX(CASE \\r\\n        WHEN flag_simples_nacional = 0 AND COALESCE(perc_participacao, 0) > 10 \\r\\n        THEN 1 ELSE 0 \\r\\n    END) AS tem_maior_10pct_normal,\\r\\n    GROUP_CONCAT(DISTINCT uf) AS ufs_empresas,\\r\\n    MAX(CASE WHEN fonte = 'SC_LOCAL' THEN 1 ELSE 0 END) AS tem_empresa_sc,\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) >= 2 \\r\\n             AND COUNT(DISTINCT CASE WHEN flag_simples_nacional = 0 THEN cnpj_raiz END) >= 1\\r\\n             AND MAX(CASE WHEN flag_simples_nacional = 0 AND COALESCE(perc_participacao, 0) > 10 THEN 1 ELSE 0 END) = 1\\r\\n            THEN 'AMBOS'\\r\\n        WHEN COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) >= 2 \\r\\n            THEN 'INCISO_III'\\r\\n        WHEN COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) >= 1 \\r\\n             AND COUNT(DISTINCT CASE WHEN flag_simples_nacional = 0 THEN cnpj_raiz END) >= 1\\r\\n             AND MAX(CASE WHEN flag_simples_nacional = 0 AND COALESCE(perc_participacao, 0) > 10 THEN 1 ELSE 0 END) = 1\\r\\n            THEN 'INCISO_IV'\\r\\n        ELSE 'SEM_IRREGULARIDADE'\\r\\n    END AS tipo_inciso\\r\\nFROM \\r\\n    gessimples.bcad_04_participacoes_todas\\r\\nGROUP BY \\r\\n    cpf_socio\\r\\nHAVING \\r\\n    COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) >= 2\\r\\n    OR (COUNT(DISTINCT CASE WHEN flag_simples_nacional = 1 THEN cnpj_raiz END) >= 1 \\r\\n        AND COUNT(DISTINCT CASE WHEN flag_simples_nacional = 0 THEN cnpj_raiz END) >= 1\\r\\n        AND MAX(CASE WHEN flag_simples_nacional = 0 AND COALESCE(perc_participacao, 0) > 10 THEN 1 ELSE 0 END) = 1)\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_05_cpfs_multiplas_empresas;\\r\\n\\r\\nSELECT 'ETAPA 5: CPFs m\\u00faltiplas empresas' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_05_cpfs_multiplas_empresas;\\r\\n\\r\\nSELECT tipo_inciso, COUNT(*) AS qtd\\r\\nFROM gessimples.bcad_05_cpfs_multiplas_empresas\\r\\nGROUP BY tipo_inciso;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 6: DETALHE PARTICIPA\\u00c7\\u00d5ES DOS GRUPOS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_06_participacoes_grupos;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_06_participacoes_grupos AS\\r\\nSELECT \\r\\n    g.cpf_socio,\\r\\n    g.tipo_inciso,\\r\\n    g.qtd_empresas_sn,\\r\\n    g.qtd_empresas_normal,\\r\\n    g.tem_maior_10pct_normal,\\r\\n    p.cnpj_raiz,\\r\\n    p.cnpj_completo,\\r\\n    p.razao_social,\\r\\n    p.uf,\\r\\n    p.situacao_cadastral,\\r\\n    p.regime_tributacao,\\r\\n    p.flag_simples_nacional,\\r\\n    COALESCE(p.perc_participacao, 0) AS perc_participacao,\\r\\n    CASE WHEN COALESCE(p.perc_participacao, 0) > 10 THEN 1 ELSE 0 END AS flag_maior_10pct,\\r\\n    p.fonte\\r\\nFROM \\r\\n    gessimples.bcad_05_cpfs_multiplas_empresas g\\r\\nINNER JOIN \\r\\n    gessimples.bcad_04_participacoes_todas p \\r\\n    ON g.cpf_socio = p.cpf_socio\\r\\nWHERE \\r\\n    g.tipo_inciso != 'SEM_IRREGULARIDADE'\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_06_participacoes_grupos;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 7: FATURAMENTO PGDAS-D\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_07_faturamento_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_07_faturamento_pgdas AS\\r\\nSELECT \\r\\n    nu_cnpj_grupo AS cnpj_raiz,\\r\\n    nu_cnpj AS cnpj,\\r\\n    nu_per_ref AS periodo_apuracao,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 5, 2) AS INT) AS mes,\\r\\n    COALESCE(vl_rec_bruta_estab, 0) AS receita_bruta,\\r\\n    'PGDAS' AS fonte\\r\\nFROM \\r\\n    usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\nWHERE \\r\\n    nu_per_ref >= 202001\\r\\n    AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_07_faturamento_pgdas;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 8: FATURAMENTO DIME\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_08_faturamento_dime;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_08_faturamento_dime AS\\r\\nSELECT \\r\\n    nu_cnpj_grupo AS cnpj_raiz,\\r\\n    nu_cnpj AS cnpj,\\r\\n    nu_per_ref AS periodo_apuracao,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 5, 2) AS INT) AS mes,\\r\\n    COALESCE(vl_receita_bruta, 0) AS receita_bruta,\\r\\n    'DIME' AS fonte\\r\\nFROM \\r\\n    usr_sat_ods.ods_decl_dime_raw\\r\\nWHERE \\r\\n    nu_per_ref >= 202001\\r\\n    AND COALESCE(sn_cancelada, 0) = 0\\r\\n    AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_08_faturamento_dime;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 9: RECEITA ANUAL POR CNPJ\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_09_receita_anual;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_09_receita_anual AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cnpj,\\r\\n    ano,\\r\\n    SUM(receita_bruta) AS receita_bruta_anual,\\r\\n    COUNT(DISTINCT periodo_apuracao) AS qtd_periodos,\\r\\n    MAX(fonte) AS fonte_principal\\r\\nFROM (\\r\\n    SELECT cnpj_raiz, cnpj, periodo_apuracao, ano, mes, receita_bruta, fonte\\r\\n    FROM gessimples.bcad_07_faturamento_pgdas\\r\\n    UNION ALL\\r\\n    SELECT cnpj_raiz, cnpj, periodo_apuracao, ano, mes, receita_bruta, fonte\\r\\n    FROM gessimples.bcad_08_faturamento_dime\\r\\n) fat\\r\\nGROUP BY \\r\\n    cnpj_raiz, cnpj, ano\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_09_receita_anual;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 10: RECEITA GLOBAL DO GRUPO\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_10_receita_global;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_10_receita_global AS\\r\\nSELECT \\r\\n    p.cpf_socio,\\r\\n    p.tipo_inciso,\\r\\n    r.ano,\\r\\n    SUM(r.receita_bruta_anual) AS receita_bruta_global,\\r\\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_com_faturamento,\\r\\n    CASE \\r\\n        WHEN SUM(r.receita_bruta_anual) > 5720000 THEN 'EXCESSO_20PCT'\\r\\n        WHEN SUM(r.receita_bruta_anual) > 4800000 THEN 'ACIMA_LIMITE'\\r\\n        ELSE 'DENTRO_LIMITE'\\r\\n    END AS situacao_limite,\\r\\n    5720000 - SUM(r.receita_bruta_anual) AS margem_excesso_20pct,\\r\\n    4800000 - SUM(r.receita_bruta_anual) AS margem_limite_normal\\r\\nFROM \\r\\n    (SELECT DISTINCT cpf_socio, tipo_inciso, cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos) p\\r\\nINNER JOIN \\r\\n    gessimples.bcad_09_receita_anual r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz\\r\\nGROUP BY \\r\\n    p.cpf_socio, p.tipo_inciso, r.ano\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_10_receita_global;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 11: RECEITA ACUMULADA MENSAL\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_11_receita_acumulada;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_11_receita_acumulada AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    mes,\\r\\n    periodo_apuracao,\\r\\n    receita_mensal_grupo,\\r\\n    SUM(receita_mensal_grupo) OVER (\\r\\n        PARTITION BY cpf_socio, ano \\r\\n        ORDER BY periodo_apuracao \\r\\n        ROWS UNBOUNDED PRECEDING\\r\\n    ) AS receita_acumulada_ano\\r\\nFROM (\\r\\n    SELECT \\r\\n        p.cpf_socio,\\r\\n        f.ano,\\r\\n        f.mes,\\r\\n        f.periodo_apuracao,\\r\\n        SUM(f.receita_bruta) AS receita_mensal_grupo\\r\\n    FROM \\r\\n        (SELECT DISTINCT cpf_socio, cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos) p\\r\\n    INNER JOIN (\\r\\n        SELECT cnpj_raiz, cnpj, periodo_apuracao, ano, mes, receita_bruta\\r\\n        FROM gessimples.bcad_07_faturamento_pgdas\\r\\n        UNION ALL\\r\\n        SELECT cnpj_raiz, cnpj, periodo_apuracao, ano, mes, receita_bruta\\r\\n        FROM gessimples.bcad_08_faturamento_dime\\r\\n    ) f ON p.cnpj_raiz = f.cnpj_raiz\\r\\n    GROUP BY \\r\\n        p.cpf_socio, f.ano, f.mes, f.periodo_apuracao\\r\\n) sub\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_11_receita_acumulada;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 12: M\\u00caS DO ESTOURO\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_12_mes_estouro;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_12_mes_estouro AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    receita_final_ano,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN 'EXCESSO_20PCT_MES_SEGUINTE'\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN 'ACIMA_LIMITE_JANEIRO_SEGUINTE'\\r\\n        ELSE NULL\\r\\n    END AS tipo_exclusao,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN \\r\\n            CAST(\\r\\n                CONCAT(\\r\\n                    CASE \\r\\n                        WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 \\r\\n                        THEN CAST(CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4) AS INT) + 1 AS STRING)\\r\\n                        ELSE SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4)\\r\\n                    END,\\r\\n                    LPAD(\\r\\n                        CAST(\\r\\n                            CASE \\r\\n                                WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 THEN 1\\r\\n                                ELSE CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) + 1\\r\\n                            END \\r\\n                        AS STRING), \\r\\n                        2, '0'\\r\\n                    )\\r\\n                ) AS INT\\r\\n            )\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN \\r\\n            CAST(CONCAT(CAST(ano + 1 AS STRING), '01') AS INT)\\r\\n        ELSE NULL\\r\\n    END AS periodo_exclusao\\r\\nFROM (\\r\\n    SELECT \\r\\n        cpf_socio,\\r\\n        ano,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN periodo_apuracao END) AS periodo_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN receita_acumulada_ano END) AS valor_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN periodo_apuracao END) AS periodo_estouro_limite,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN receita_acumulada_ano END) AS valor_estouro_limite,\\r\\n        MAX(receita_acumulada_ano) AS receita_final_ano\\r\\n    FROM \\r\\n        gessimples.bcad_11_receita_acumulada\\r\\n    GROUP BY \\r\\n        cpf_socio, ano\\r\\n) primeiro_estouro\\r\\nWHERE \\r\\n    periodo_estouro_20pct IS NOT NULL OR periodo_estouro_limite IS NOT NULL\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_12_mes_estouro;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 13: RESULTADO FINAL - VIOLA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_13_violacoes_final;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_13_violacoes_final AS\\r\\nSELECT \\r\\n    DENSE_RANK() OVER (ORDER BY rg.receita_bruta_global DESC, rg.cpf_socio) AS num_grupo,\\r\\n    rg.cpf_socio,\\r\\n    cpf.nomecontribuinte AS nome_socio,\\r\\n    rg.tipo_inciso,\\r\\n    rg.ano AS ano_apuracao,\\r\\n    rg.receita_bruta_global,\\r\\n    rg.qtd_empresas_com_faturamento,\\r\\n    rg.situacao_limite,\\r\\n    rg.margem_excesso_20pct,\\r\\n    rg.margem_limite_normal,\\r\\n    me.periodo_estouro_20pct,\\r\\n    me.valor_estouro_20pct,\\r\\n    me.periodo_estouro_limite,\\r\\n    me.valor_estouro_limite,\\r\\n    me.tipo_exclusao,\\r\\n    me.periodo_exclusao,\\r\\n    g.qtd_empresas_total,\\r\\n    g.qtd_empresas_sn,\\r\\n    g.qtd_empresas_normal,\\r\\n    g.ufs_empresas,\\r\\n    NOW() AS dt_processamento\\r\\nFROM \\r\\n    gessimples.bcad_10_receita_global rg\\r\\nINNER JOIN \\r\\n    gessimples.bcad_05_cpfs_multiplas_empresas g \\r\\n    ON rg.cpf_socio = g.cpf_socio\\r\\nLEFT JOIN \\r\\n    gessimples.bcad_12_mes_estouro me \\r\\n    ON rg.cpf_socio = me.cpf_socio AND rg.ano = me.ano\\r\\nLEFT JOIN \\r\\n    bcadastro.cpf cpf \\r\\n    ON rg.cpf_socio = cpf.cpfid\\r\\nWHERE \\r\\n    rg.situacao_limite IN ('EXCESSO_20PCT', 'ACIMA_LIMITE')\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_13_violacoes_final;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 14: DETALHE POR EMPRESA\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_14_violacoes_detalhe;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_14_violacoes_detalhe AS\\r\\nSELECT \\r\\n    v.num_grupo,\\r\\n    v.cpf_socio,\\r\\n    v.nome_socio,\\r\\n    v.tipo_inciso,\\r\\n    v.ano_apuracao,\\r\\n    v.receita_bruta_global AS receita_global_grupo,\\r\\n    v.situacao_limite,\\r\\n    v.tipo_exclusao,\\r\\n    v.periodo_exclusao,\\r\\n    p.cnpj_raiz,\\r\\n    p.cnpj_completo,\\r\\n    p.razao_social,\\r\\n    p.uf,\\r\\n    p.regime_tributacao,\\r\\n    p.flag_simples_nacional,\\r\\n    p.perc_participacao,\\r\\n    p.flag_maior_10pct,\\r\\n    p.fonte AS fonte_dados,\\r\\n    COALESCE(r.receita_bruta_anual, 0) AS receita_bruta_empresa,\\r\\n    r.qtd_periodos AS periodos_declarados,\\r\\n    r.fonte_principal AS fonte_receita\\r\\nFROM \\r\\n    gessimples.bcad_13_violacoes_final v\\r\\nINNER JOIN \\r\\n    gessimples.bcad_06_participacoes_grupos p \\r\\n    ON v.cpf_socio = p.cpf_socio\\r\\nLEFT JOIN \\r\\n    gessimples.bcad_09_receita_anual r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz AND v.ano_apuracao = r.ano\\r\\n;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_14_violacoes_detalhe;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- VIEWS DE CONSULTA\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v4_resumo;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v4_resumo AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global,\\r\\n    situacao_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas\\r\\nFROM \\r\\n    gessimples.bcad_13_violacoes_final\\r\\n;\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v4_estatisticas;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v4_estatisticas AS\\r\\nSELECT \\r\\n    ano_apuracao,\\r\\n    tipo_inciso,\\r\\n    situacao_limite,\\r\\n    COUNT(DISTINCT num_grupo) AS qtd_grupos,\\r\\n    COUNT(DISTINCT cpf_socio) AS qtd_socios,\\r\\n    SUM(receita_bruta_global) AS soma_receita,\\r\\n    AVG(receita_bruta_global) AS media_receita,\\r\\n    MIN(receita_bruta_global) AS min_receita,\\r\\n    MAX(receita_bruta_global) AS max_receita\\r\\nFROM \\r\\n    gessimples.bcad_13_violacoes_final\\r\\nGROUP BY \\r\\n    ano_apuracao, tipo_inciso, situacao_limite\\r\\n;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- QUERIES DE VERIFICA\\u00c7\\u00c3O\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'ETAPA 01: CPFs SC' AS etapa, COUNT(*) AS qtd FROM gessimples.bcad_01_cpfs_socios_sc\\r\\nUNION ALL SELECT 'ETAPA 02: Empresas bcadastro', COUNT(*) FROM gessimples.bcad_02_empresas_bcadastro\\r\\nUNION ALL SELECT 'ETAPA 03: Empresas SC', COUNT(*) FROM gessimples.bcad_03_empresas_sc\\r\\nUNION ALL SELECT 'ETAPA 04: Participa\\u00e7\\u00f5es', COUNT(*) FROM gessimples.bcad_04_participacoes_todas\\r\\nUNION ALL SELECT 'ETAPA 05: CPFs m\\u00faltiplas', COUNT(*) FROM gessimples.bcad_05_cpfs_multiplas_empresas\\r\\nUNION ALL SELECT 'ETAPA 06: Part. grupos', COUNT(*) FROM gessimples.bcad_06_participacoes_grupos\\r\\nUNION ALL SELECT 'ETAPA 07: Fat. PGDAS', COUNT(*) FROM gessimples.bcad_07_faturamento_pgdas\\r\\nUNION ALL SELECT 'ETAPA 08: Fat. DIME', COUNT(*) FROM gessimples.bcad_08_faturamento_dime\\r\\nUNION ALL SELECT 'ETAPA 09: Rec. anual', COUNT(*) FROM gessimples.bcad_09_receita_anual\\r\\nUNION ALL SELECT 'ETAPA 10: Rec. global', COUNT(*) FROM gessimples.bcad_10_receita_global\\r\\nUNION ALL SELECT 'ETAPA 13: Viola\\u00e7\\u00f5es', COUNT(*) FROM gessimples.bcad_13_violacoes_final\\r\\nUNION ALL SELECT 'ETAPA 14: Detalhe', COUNT(*) FROM gessimples.bcad_14_violacoes_detalhe\\r\\n;\\r\\n\\r\\n-- Por fonte\\r\\nSELECT fonte, COUNT(*) AS qtd, COUNT(DISTINCT cpf_socio) AS cpfs\\r\\nFROM gessimples.bcad_04_participacoes_todas\\r\\nGROUP BY fonte;\\r\\n\\r\\n-- Por inciso\\r\\nSELECT tipo_inciso, COUNT(*) AS qtd\\r\\nFROM gessimples.bcad_05_cpfs_multiplas_empresas\\r\\nGROUP BY tipo_inciso;\\r\\n\\r\\n-- Top 20\\r\\nSELECT * FROM gessimples.vw_bcad_v4_resumo \\r\\nORDER BY receita_bruta_global DESC \\r\\nLIMIT 20;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 4: Pipeline SC \\u2192 CPFs \\u2192 bcadastro\\r\\n-- ============================================================================\\r\\n-- VERS\\u00c3O IMPALA - Usando sintaxe correta para explodir arrays\\r\\n-- Sintaxe: FROM tabela t, t.array_column item\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 1: EXTRAIR CPFs DO CADASTRO LOCAL SC (cad_vinculo)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_01_cpfs_socios_sc;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_01_cpfs_socios_sc AS\\r\\nSELECT \\r\\n    v.nu_cnpj_cpf_secund AS cpf_socio,\\r\\n    COUNT(DISTINCT v.nu_cnpj_princ) AS qtd_empresas_sc,\\r\\n    MAX(v.nm_qualificacao) AS exemplo_qualificacao,\\r\\n    MIN(v.dt_inicio_relacao) AS primeira_relacao,\\r\\n    MAX(v.dt_inicio_relacao) AS ultima_relacao\\r\\nFROM \\r\\n    usr_sat_ods.vw_cad_vinculo v\\r\\nWHERE \\r\\n    v.nm_relacao NOT IN ('CONTABILISTA')\\r\\n    AND v.nu_cnpj_cpf_secund IS NOT NULL\\r\\n    AND LENGTH(TRIM(v.nu_cnpj_cpf_secund)) = 11\\r\\n    AND (v.sn_relacao_ativa = 1 \\r\\n         OR v.dt_fim_relacao IS NULL \\r\\n         OR v.dt_fim_relacao >= '2020-01-01')\\r\\nGROUP BY \\r\\n    v.nu_cnpj_cpf_secund\\r\\n;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_01_cpfs_socios_sc;\", \"\\r\\n\\r\\n-- Verifica\\u00e7\\u00e3o\\r\\nSELECT 'ETAPA 1: CPFs \\u00fanicos de SC' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_01_cpfs_socios_sc;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 2: EXPLODIR S\\u00d3CIOS DO BCADASTRO E FILTRAR POR CPFs DE SC\\r\\n-- ============================================================================\\r\\n-- Usando sintaxe Impala: FROM tabela t, t.array_column item\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_02_empresas_bcadastro;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_02_empresas_bcadastro AS\\r\\nSELECT DISTINCT\\r\\n    -- Extrair CPF do s\\u00f3cio (padronizar formato)\\r\\n    LPAD(REGEXP_REPLACE(TRIM(CAST(socio.cpfcnpj AS STRING)), '^0+', ''), 11, '0') AS cpf_socio,\\r\\n    m.cnpj AS cnpj_raiz,\\r\\n    m.nomeempresarial AS razao_social,\\r\\n    m.naturezajuridica,\\r\\n    m.porteempresa,\\r\\n    socio.qualificacaosocio,\\r\\n    socio.dataentrada,\\r\\n    -- Dados do estabelecimento\\r\\n    est.cnpj AS cnpj_completo,\\r\\n    est.uf,\\r\\n    est.situacaocadastral,\\r\\n    est.datasituacaocadastral,\\r\\n    est.nomefantasia,\\r\\n    est.cnaefiscal,\\r\\n    -- Dados do Simples Nacional\\r\\n    CASE \\r\\n        WHEN hist_sn.cnpj IS NOT NULL THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS tem_historico_sn,\\r\\n    -- Flag SN: se tem registro na tabela sn, considera que teve/tem SN\\r\\n    CASE \\r\\n        WHEN hist_sn.cnpj IS NOT NULL THEN 1\\r\\n        ELSE 0 \\r\\n    END AS flag_simples_nacional_atual\\r\\nFROM \\r\\n    bcadastro.cnpj_matriz m,\\r\\n    m.socios socio  -- Sintaxe Impala para explodir array\\r\\n-- FILTRO: Apenas CPFs de SC\\r\\nINNER JOIN \\r\\n    gessimples.bcad_01_cpfs_socios_sc cpf_sc \\r\\n    ON LPAD(REGEXP_REPLACE(TRIM(CAST(socio.cpfcnpj AS STRING)), '^0+', ''), 11, '0') = cpf_sc.cpf_socio\\r\\n-- Join com estabelecimento (matriz)\\r\\nLEFT JOIN \\r\\n    bcadastro.cnpj_estabelecimento est \\r\\n    ON SUBSTR(est.cnpj, 1, 8) = m.cnpj \\r\\n    AND est.indicadormatriz = '1'\\r\\n-- Join com hist\\u00f3rico SN\\r\\nLEFT JOIN \\r\\n    bcadastro.sn hist_sn \\r\\n    ON hist_sn.cnpj = m.cnpj\\r\\nWHERE \\r\\n    -- Apenas s\\u00f3cios PF (tipo = 2)\\r\\n    socio.tipo = '2'\\r\\n    AND socio.cpfcnpj IS NOT NULL\\r\\n    AND LENGTH(TRIM(CAST(socio.cpfcnpj AS STRING))) >= 11\\r\\n    -- Excluir empresas baixadas h\\u00e1 muito tempo\\r\\n    AND (est.situacaocadastral IS NULL \\r\\n         OR est.situacaocadastral NOT IN ('08')\\r\\n         OR est.datasituacaocadastral >= '20200101')\\r\\n;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_02_empresas_bcadastro;\", \"\\r\\n\\r\\n-- Adicionar respons\\u00e1veis de empresas sem s\\u00f3cios (MEI, EI, etc.)\\r\\nINSERT INTO gessimples.bcad_02_empresas_bcadastro\\r\\nSELECT DISTINCT\\r\\n    LPAD(m.cpfresponsavel, 11, '0') AS cpf_socio,\\r\\n    m.cnpj AS cnpj_raiz,\\r\\n    m.nomeempresarial AS razao_social,\\r\\n    m.naturezajuridica,\\r\\n    m.porteempresa,\\r\\n    m.qualificacaoresponsavel AS qualificacaosocio,\\r\\n    m.datainclusaoresponsavel AS dataentrada,\\r\\n    est.cnpj AS cnpj_completo,\\r\\n    est.uf,\\r\\n    est.situacaocadastral,\\r\\n    est.datasituacaocadastral,\\r\\n    est.nomefantasia,\\r\\n    est.cnaefiscal,\\r\\n    CASE WHEN hist_sn.cnpj IS NOT NULL THEN 1 ELSE 0 END AS tem_historico_sn,\\r\\n    CASE WHEN hist_sn.cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_simples_nacional_atual\\r\\nFROM \\r\\n    bcadastro.cnpj_matriz m\\r\\nINNER JOIN \\r\\n    gessimples.bcad_01_cpfs_socios_sc cpf_sc \\r\\n    ON LPAD(m.cpfresponsavel, 11, '0') = cpf_sc.cpf_socio\\r\\nLEFT JOIN \\r\\n    bcadastro.cnpj_estabelecimento est \\r\\n    ON SUBSTR(est.cnpj, 1, 8) = m.cnpj \\r\\n    AND est.indicadormatriz = '1'\\r\\nLEFT JOIN \\r\\n    bcadastro.sn hist_sn \\r\\n    ON hist_sn.cnpj = m.cnpj\\r\\nWHERE \\r\\n    m.cpfresponsavel IS NOT NULL\\r\\n    AND m.cpfresponsavel != ''\\r\\n    AND LENGTH(TRIM(m.cpfresponsavel)) >= 11\\r\\n    AND (est.situacaocadastral IS NULL \\r\\n         OR est.situacaocadastral NOT IN ('08')\\r\\n         OR est.datasituacaocadastral >= '20200101')\\r\\n    -- Evitar duplicatas (empresas j\\u00e1 inclu\\u00eddas via array de s\\u00f3cios)\\r\\n    AND NOT EXISTS (\\r\\n        SELECT 1 FROM gessimples.bcad_02_empresas_bcadastro b\\r\\n        WHERE b.cpf_socio = LPAD(m.cpfresponsavel, 11, '0')\\r\\n        AND b.cnpj_raiz = m.cnpj\\r\\n    )\\r\\n;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_02_empresas_bcadastro;\", \"\\r\\n\\r\\n-- Verifica\\u00e7\\u00e3o\\r\\nSELECT 'ETAPA 2: Empresas bcadastro' AS etapa, COUNT(*) AS qtd \\r\\nFROM gessimples.bcad_02_empresas_bcadastro;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 4: Pipeline SC \\u2192 CPFs \\u2192 bcadastro\\r\\n-- ============================================================================\\r\\n-- VERS\\u00c3O IMPALA - Usando sintaxe correta para explodir arrays\\r\\n-- Sintaxe: FROM tabela t, t.array_column item\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"5cc34dc3-44ab-79e9-9361-2ff8652cd099\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"GD/4hgsCT6qf84dmlLNNMw==\", \"guid\": \"NfCT1S9MQScAAAAAsNqbng==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3e4a48a3a838dbc4:71bc5146f6698381\", \"session_id\": 23528, \"session_type\": \"impala\", \"statement_id\": 3, \"has_more_statements\": false, \"statements_count\": 4, \"previous_statement_hash\": \"8e75e2081a79d7b953ca111eb824eaf5f06d27f5a3cc9f63433a3021\", \"start\": {\"row\": 29, \"column\": 0}, \"end\": {\"row\": 32, \"column\": 8}, \"statement\": \"-- Top 20\\nSELECT * FROM gessimples.vw_bcad_v4_resumo \\nORDER BY receita_bruta_global DESC \\nLIMIT 20\"}, \"meta\": [], \"rows\": 20, \"hasMore\": false, \"statement_id\": 3, \"statement_range\": {\"start\": {\"row\": 29, \"column\": 0}, \"end\": {\"row\": 32, \"column\": 8}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-12-04T19:19:05.953Z\", \"endTime\": \"2025-12-04T19:19:07.297Z\", \"executionTime\": 1344, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"ano_apuracao\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"ano_apuracao\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764875945658, \"lastAceSelectionRowOffset\": 708, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 239, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- PROJETO GENESIS - Versão 4: Pipeline SC → CPFs → bcadastro\r\n-- ============================================================================\r\n-- VERSÃO IMPALA - Usando sintaxe correta para explodir arrays\r\n-- Sintaxe: FROM tabela t, t.array_column item\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- ETAPA 1: EXTRAIR CPFs DO CADASTRO LOCAL SC (cad_vinculo)\r\n-- ============================================================================\r\n\r\nDROP TABLE IF EXISTS gessimples.bcad_01_cpfs_socios_sc;\r\n\r\nCREATE TABLE gessimples.bcad_01_cpfs_socios_sc AS\r\nSELECT \r\n    v.nu_cnpj_cpf_secund AS cpf_socio,\r\n    COUNT(DISTINCT v.nu_cnpj_princ) AS qtd_empresas_sc,\r\n    MAX(v.nm_qualificacao) AS exemplo_qualificacao,\r\n    MIN(v.dt_inicio_relacao) AS primeira_relacao,\r\n    MAX(v.dt_inicio_relacao) AS ultima_relacao\r\nFROM \r\n    usr_sat_ods.vw_cad_vinculo v\r\nWHERE \r\n    v.nm_relacao NOT IN ('CONTABILISTA')\r\n    AND v.nu_cnpj_cpf_secund IS NOT NULL\r\n    AND LENGTH(TRIM(v.nu_cnpj_cpf_secund)) = 11\r\n    AND (v.sn_relacao_ativa = 1 \r\n         OR v.dt_fim_relacao IS NULL \r\n         OR v.dt_fim_relacao >= '2020-01-01')\r\nGROUP BY \r\n    v.nu_cnpj_cpf_secund\r\n;\r\n\r\nCOMPUTE STATS gessimples.bcad_01_cpfs_socios_sc;\r\n\r\n-- Verificação\r\nSELECT 'ETAPA 1: CPFs únicos de SC' AS etapa, COUNT(*) AS qtd \r\nFROM gessimples.bcad_01_cpfs_socios_sc;\r\n\r\n\r\n-- ============================================================================\r\n-- ETAPA 2: EXPLODIR SÓCIOS DO BCADASTRO E FILTRAR POR CPFs DE SC\r\n-- ============================================================================\r\n-- Usando sintaxe Impala: FROM tabela t, t.array_column item\r\n\r\nDROP TABLE IF EXISTS gessimples.bcad_02_empresas_bcadastro;\r\n\r\nCREATE TABLE gessimples.bcad_02_empresas_bcadastro AS\r\nSELECT DISTINCT\r\n    --",
    "last_modified": "2026-01-05T15:39:28.171",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "0ecc1bc7-7639-4257-85c5-678adbb678b9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 186675,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCAD 02",
    "description": "",
    "uuid": "64626748-4681-3316-70a9-d77efcb93ebc",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 186675, \"uuid\": \"64626748-4681-3316-70a9-d77efcb93ebc\", \"name\": \"BCAD 02\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"39849ab4-6ebe-a08e-4503-e584bc7ca192\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 5: CORRE\\u00c7\\u00d5ES APLICADAS\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00d5ES:\\r\\n-- 1. Receita global considera apenas empresas do Simples Nacional\\r\\n-- 2. Removidas duplicatas na receita anual (agrega\\u00e7\\u00e3o por CNPJ+ano)\\r\\n-- 3. DISTINCT na tabela final de viola\\u00e7\\u00f5es\\r\\n-- 4. Filtro para excluir empresas de capital aberto (natureza jur\\u00eddica)\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 9B: RECEITA ANUAL - CORRIGIDA (sem duplicatas)\\r\\n-- ============================================================================\\r\\n-- Problema: mesmo CNPJ pode ter m\\u00faltiplos registros por ter filiais\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_09b_receita_anual_corrigida;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_09b_receita_anual_corrigida AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    SUM(receita_bruta) AS receita_bruta_anual,\\r\\n    COUNT(DISTINCT periodo_apuracao) AS qtd_periodos,\\r\\n    MAX(fonte) AS fonte_principal\\r\\nFROM (\\r\\n    -- PGDAS: agregar por CNPJ_RAIZ (n\\u00e3o por estabelecimento)\\r\\n    SELECT \\r\\n        nu_cnpj_grupo AS cnpj_raiz,\\r\\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta,\\r\\n        'PGDAS' AS fonte\\r\\n    FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\n    WHERE nu_per_ref >= 202001\\r\\n      AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n    GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- DIME: agregar por CNPJ_RAIZ\\r\\n    SELECT \\r\\n        nu_cnpj_grupo AS cnpj_raiz,\\r\\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(vl_receita_bruta, 0)) AS receita_bruta,\\r\\n        'DIME' AS fonte\\r\\n    FROM usr_sat_ods.ods_decl_dime_raw\\r\\n    WHERE nu_per_ref >= 202001\\r\\n      AND COALESCE(sn_cancelada, 0) = 0\\r\\n      AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n    GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n) fat\\r\\nGROUP BY cnpj_raiz, ano;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_09b_receita_anual_corrigida;\\r\\n\\r\\n-- Verificar se ainda h\\u00e1 duplicatas\\r\\nSELECT 'Duplicatas ap\\u00f3s corre\\u00e7\\u00e3o' AS check_type, COUNT(*) AS qtd\\r\\nFROM (\\r\\n    SELECT cnpj_raiz, ano, COUNT(*) AS c\\r\\n    FROM gessimples.bcad_09b_receita_anual_corrigida\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n    HAVING COUNT(*) > 1\\r\\n) dup;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 10B: RECEITA GLOBAL - APENAS EMPRESAS SIMPLES NACIONAL\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00c3O PRINCIPAL: Soma apenas receita de empresas NO Simples Nacional\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_10b_receita_global_sn;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_10b_receita_global_sn AS\\r\\nSELECT \\r\\n    p.cpf_socio,\\r\\n    p.tipo_inciso,\\r\\n    r.ano,\\r\\n    -- Soma apenas empresas SN\\r\\n    SUM(r.receita_bruta_anual) AS receita_bruta_global_sn,\\r\\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_sn_com_faturamento,\\r\\n    CASE \\r\\n        WHEN SUM(r.receita_bruta_anual) > 5720000 THEN 'EXCESSO_20PCT'\\r\\n        WHEN SUM(r.receita_bruta_anual) > 4800000 THEN 'ACIMA_LIMITE'\\r\\n        ELSE 'DENTRO_LIMITE'\\r\\n    END AS situacao_limite,\\r\\n    5720000 - SUM(r.receita_bruta_anual) AS margem_excesso_20pct,\\r\\n    4800000 - SUM(r.receita_bruta_anual) AS margem_limite_normal\\r\\nFROM \\r\\n    (SELECT DISTINCT cpf_socio, tipo_inciso, cnpj_raiz \\r\\n     FROM gessimples.bcad_06_participacoes_grupos\\r\\n     WHERE flag_simples_nacional = 1  -- APENAS EMPRESAS SN\\r\\n    ) p\\r\\nINNER JOIN \\r\\n    gessimples.bcad_09b_receita_anual_corrigida r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz\\r\\nGROUP BY \\r\\n    p.cpf_socio, p.tipo_inciso, r.ano;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_10b_receita_global_sn;\\r\\n\\r\\n-- Estat\\u00edsticas\\r\\nSELECT \\r\\n    'Receita Global SN' AS tabela,\\r\\n    COUNT(*) AS registros,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs,\\r\\n    SUM(CASE WHEN situacao_limite != 'DENTRO_LIMITE' THEN 1 ELSE 0 END) AS violacoes\\r\\nFROM gessimples.bcad_10b_receita_global_sn;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 11B: RECEITA ACUMULADA MENSAL - APENAS SN\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_11b_receita_acumulada_sn;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_11b_receita_acumulada_sn AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    mes,\\r\\n    periodo_apuracao,\\r\\n    receita_mensal_grupo,\\r\\n    SUM(receita_mensal_grupo) OVER (\\r\\n        PARTITION BY cpf_socio, ano \\r\\n        ORDER BY periodo_apuracao \\r\\n        ROWS UNBOUNDED PRECEDING\\r\\n    ) AS receita_acumulada_ano\\r\\nFROM (\\r\\n    SELECT \\r\\n        p.cpf_socio,\\r\\n        CAST(SUBSTR(CAST(f.periodo_apuracao AS STRING), 1, 4) AS INT) AS ano,\\r\\n        CAST(SUBSTR(CAST(f.periodo_apuracao AS STRING), 5, 2) AS INT) AS mes,\\r\\n        f.periodo_apuracao,\\r\\n        SUM(f.receita_bruta) AS receita_mensal_grupo\\r\\n    FROM \\r\\n        (SELECT DISTINCT cpf_socio, cnpj_raiz \\r\\n         FROM gessimples.bcad_06_participacoes_grupos\\r\\n         WHERE flag_simples_nacional = 1  -- APENAS EMPRESAS SN\\r\\n        ) p\\r\\n    INNER JOIN (\\r\\n        -- PGDAS agregado\\r\\n        SELECT \\r\\n            nu_cnpj_grupo AS cnpj_raiz,\\r\\n            nu_per_ref AS periodo_apuracao,\\r\\n            SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta\\r\\n        FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\n        WHERE nu_per_ref >= 202001\\r\\n          AND nu_cnpj_grupo IN (\\r\\n              SELECT DISTINCT cnpj_raiz \\r\\n              FROM gessimples.bcad_06_participacoes_grupos\\r\\n              WHERE flag_simples_nacional = 1\\r\\n          )\\r\\n        GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n    ) f ON p.cnpj_raiz = f.cnpj_raiz\\r\\n    GROUP BY p.cpf_socio, f.periodo_apuracao\\r\\n) sub;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_11b_receita_acumulada_sn;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 12B: M\\u00caS DO ESTOURO - APENAS SN\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_12b_mes_estouro_sn;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_12b_mes_estouro_sn AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    receita_final_ano,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN 'EXCESSO_20PCT_MES_SEGUINTE'\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN 'ACIMA_LIMITE_JANEIRO_SEGUINTE'\\r\\n        ELSE NULL\\r\\n    END AS tipo_exclusao,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN \\r\\n            CAST(\\r\\n                CONCAT(\\r\\n                    CASE \\r\\n                        WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 \\r\\n                        THEN CAST(CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4) AS INT) + 1 AS STRING)\\r\\n                        ELSE SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4)\\r\\n                    END,\\r\\n                    LPAD(\\r\\n                        CAST(\\r\\n                            CASE \\r\\n                                WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 THEN 1\\r\\n                                ELSE CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) + 1\\r\\n                            END \\r\\n                        AS STRING), \\r\\n                        2, '0'\\r\\n                    )\\r\\n                ) AS INT\\r\\n            )\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN \\r\\n            CAST(CONCAT(CAST(ano + 1 AS STRING), '01') AS INT)\\r\\n        ELSE NULL\\r\\n    END AS periodo_exclusao\\r\\nFROM (\\r\\n    SELECT \\r\\n        cpf_socio,\\r\\n        ano,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN periodo_apuracao END) AS periodo_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN receita_acumulada_ano END) AS valor_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN periodo_apuracao END) AS periodo_estouro_limite,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN receita_acumulada_ano END) AS valor_estouro_limite,\\r\\n        MAX(receita_acumulada_ano) AS receita_final_ano\\r\\n    FROM gessimples.bcad_11b_receita_acumulada_sn\\r\\n    GROUP BY cpf_socio, ano\\r\\n) primeiro_estouro\\r\\nWHERE periodo_estouro_20pct IS NOT NULL OR periodo_estouro_limite IS NOT NULL;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_12b_mes_estouro_sn;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 13B: RESULTADO FINAL - VIOLA\\u00c7\\u00d5ES (SEM DUPLICATAS)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_13b_violacoes_final_sn;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_13b_violacoes_final_sn AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global_sn,\\r\\n    qtd_empresas_sn_com_faturamento,\\r\\n    situacao_limite,\\r\\n    margem_excesso_20pct,\\r\\n    margem_limite_normal,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_total,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas,\\r\\n    dt_processamento\\r\\nFROM (\\r\\n    SELECT \\r\\n        DENSE_RANK() OVER (ORDER BY rg.receita_bruta_global_sn DESC, rg.cpf_socio) AS num_grupo,\\r\\n        rg.cpf_socio,\\r\\n        cpf.nomecontribuinte AS nome_socio,\\r\\n        rg.tipo_inciso,\\r\\n        rg.ano AS ano_apuracao,\\r\\n        rg.receita_bruta_global_sn,\\r\\n        rg.qtd_empresas_sn_com_faturamento,\\r\\n        rg.situacao_limite,\\r\\n        rg.margem_excesso_20pct,\\r\\n        rg.margem_limite_normal,\\r\\n        me.periodo_estouro_20pct,\\r\\n        me.valor_estouro_20pct,\\r\\n        me.periodo_estouro_limite,\\r\\n        me.valor_estouro_limite,\\r\\n        me.tipo_exclusao,\\r\\n        me.periodo_exclusao,\\r\\n        g.qtd_empresas_total,\\r\\n        g.qtd_empresas_sn,\\r\\n        g.qtd_empresas_normal,\\r\\n        g.ufs_empresas,\\r\\n        NOW() AS dt_processamento,\\r\\n        ROW_NUMBER() OVER (PARTITION BY rg.cpf_socio, rg.ano ORDER BY rg.receita_bruta_global_sn DESC) AS rn\\r\\n    FROM \\r\\n        gessimples.bcad_10b_receita_global_sn rg\\r\\n    INNER JOIN \\r\\n        gessimples.bcad_05_cpfs_multiplas_empresas g \\r\\n        ON rg.cpf_socio = g.cpf_socio\\r\\n    LEFT JOIN \\r\\n        gessimples.bcad_12b_mes_estouro_sn me \\r\\n        ON rg.cpf_socio = me.cpf_socio AND rg.ano = me.ano\\r\\n    LEFT JOIN \\r\\n        bcadastro.cpf cpf \\r\\n        ON rg.cpf_socio = cpf.cpfid\\r\\n    WHERE \\r\\n        rg.situacao_limite IN ('EXCESSO_20PCT', 'ACIMA_LIMITE')\\r\\n) ranked\\r\\nWHERE rn = 1;  -- Remove duplicatas mantendo apenas 1 registro por CPF+ano\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_13b_violacoes_final_sn;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 14B: DETALHE POR EMPRESA (apenas SN)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_14b_violacoes_detalhe_sn;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_14b_violacoes_detalhe_sn AS\\r\\nSELECT DISTINCT\\r\\n    v.num_grupo,\\r\\n    v.cpf_socio,\\r\\n    v.nome_socio,\\r\\n    v.tipo_inciso,\\r\\n    v.ano_apuracao,\\r\\n    v.receita_bruta_global_sn AS receita_global_grupo,\\r\\n    v.situacao_limite,\\r\\n    v.tipo_exclusao,\\r\\n    v.periodo_exclusao,\\r\\n    p.cnpj_raiz,\\r\\n    p.cnpj_completo,\\r\\n    p.razao_social,\\r\\n    p.uf,\\r\\n    p.regime_tributacao,\\r\\n    p.flag_simples_nacional,\\r\\n    p.perc_participacao,\\r\\n    p.flag_maior_10pct,\\r\\n    p.fonte AS fonte_dados,\\r\\n    COALESCE(r.receita_bruta_anual, 0) AS receita_bruta_empresa,\\r\\n    r.qtd_periodos AS periodos_declarados,\\r\\n    r.fonte_principal AS fonte_receita\\r\\nFROM \\r\\n    gessimples.bcad_13b_violacoes_final_sn v\\r\\nINNER JOIN \\r\\n    gessimples.bcad_06_participacoes_grupos p \\r\\n    ON v.cpf_socio = p.cpf_socio\\r\\nLEFT JOIN \\r\\n    gessimples.bcad_09b_receita_anual_corrigida r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz AND v.ano_apuracao = r.ano;\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_14b_violacoes_detalhe_sn;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- VIEWS CORRIGIDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v5_resumo;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v5_resumo AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global_sn AS receita_bruta_global,\\r\\n    situacao_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn;\\r\\n\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v5_estatisticas;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v5_estatisticas AS\\r\\nSELECT \\r\\n    ano_apuracao,\\r\\n    tipo_inciso,\\r\\n    situacao_limite,\\r\\n    COUNT(*) AS qtd_grupos,\\r\\n    COUNT(DISTINCT cpf_socio) AS qtd_socios,\\r\\n    SUM(receita_bruta_global_sn) AS soma_receita,\\r\\n    AVG(receita_bruta_global_sn) AS media_receita,\\r\\n    MIN(receita_bruta_global_sn) AS min_receita,\\r\\n    MAX(receita_bruta_global_sn) AS max_receita\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn\\r\\nGROUP BY ano_apuracao, tipo_inciso, situacao_limite;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Comparativo V4 vs V5\\r\\nSELECT \\r\\n    'V4 Original' AS versao,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs_unicos,\\r\\n    COUNT(DISTINCT CONCAT(cpf_socio, '-', CAST(ano_apuracao AS STRING))) AS cpf_ano_unicos,\\r\\n    MAX(receita_bruta_global) AS max_receita\\r\\nFROM gessimples.bcad_13_violacoes_final\\r\\nUNION ALL\\r\\nSELECT \\r\\n    'V5 Corrigida',\\r\\n    COUNT(*),\\r\\n    COUNT(DISTINCT cpf_socio),\\r\\n    COUNT(DISTINCT CONCAT(cpf_socio, '-', CAST(ano_apuracao AS STRING))),\\r\\n    MAX(receita_bruta_global_sn)\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn;\\r\\n\\r\\n\\r\\n-- Distribui\\u00e7\\u00e3o por faixa de receita (V5)\\r\\nSELECT \\r\\n    CASE \\r\\n        WHEN receita_bruta_global_sn <= 4800000 THEN 'At\\u00e9 4.8M'\\r\\n        WHEN receita_bruta_global_sn <= 5720000 THEN '4.8M - 5.72M'\\r\\n        WHEN receita_bruta_global_sn <= 10000000 THEN '5.72M - 10M'\\r\\n        WHEN receita_bruta_global_sn <= 20000000 THEN '10M - 20M'\\r\\n        WHEN receita_bruta_global_sn <= 50000000 THEN '20M - 50M'\\r\\n        ELSE 'Acima 50M'\\r\\n    END AS faixa,\\r\\n    COUNT(*) AS qtd,\\r\\n    MIN(receita_bruta_global_sn) AS min_val,\\r\\n    MAX(receita_bruta_global_sn) AS max_val\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN receita_bruta_global_sn <= 4800000 THEN 'At\\u00e9 4.8M'\\r\\n        WHEN receita_bruta_global_sn <= 5720000 THEN '4.8M - 5.72M'\\r\\n        WHEN receita_bruta_global_sn <= 10000000 THEN '5.72M - 10M'\\r\\n        WHEN receita_bruta_global_sn <= 20000000 THEN '10M - 20M'\\r\\n        WHEN receita_bruta_global_sn <= 50000000 THEN '20M - 50M'\\r\\n        ELSE 'Acima 50M'\\r\\n    END\\r\\nORDER BY MIN(receita_bruta_global_sn);\\r\\n\\r\\n\\r\\n-- Top 20 viola\\u00e7\\u00f5es (V5)\\r\\nSELECT * FROM gessimples.vw_bcad_v5_resumo \\r\\nORDER BY receita_bruta_global DESC \\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- Por tipo de inciso\\r\\nSELECT \\r\\n    tipo_inciso,\\r\\n    COUNT(*) AS qtd_violacoes,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs_distintos,\\r\\n    AVG(receita_bruta_global_sn) AS media_receita,\\r\\n    MAX(receita_bruta_global_sn) AS max_receita\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn\\r\\nGROUP BY tipo_inciso\\r\\nORDER BY COUNT(*) DESC;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 5: CORRE\\u00c7\\u00d5ES APLICADAS\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00d5ES:\\r\\n-- 1. Receita global considera apenas empresas do Simples Nacional\\r\\n-- 2. Removidas duplicatas na receita anual (agrega\\u00e7\\u00e3o por CNPJ+ano)\\r\\n-- 3. DISTINCT na tabela final de viola\\u00e7\\u00f5es\\r\\n-- 4. Filtro para excluir empresas de capital aberto (natureza jur\\u00eddica)\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 9B: RECEITA ANUAL - CORRIGIDA (sem duplicatas)\\r\\n-- ============================================================================\\r\\n-- Problema: mesmo CNPJ pode ter m\\u00faltiplos registros por ter filiais\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_09b_receita_anual_corrigida;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_09b_receita_anual_corrigida AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    SUM(receita_bruta) AS receita_bruta_anual,\\r\\n    COUNT(DISTINCT periodo_apuracao) AS qtd_periodos,\\r\\n    MAX(fonte) AS fonte_principal\\r\\nFROM (\\r\\n    -- PGDAS: agregar por CNPJ_RAIZ (n\\u00e3o por estabelecimento)\\r\\n    SELECT \\r\\n        nu_cnpj_grupo AS cnpj_raiz,\\r\\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta,\\r\\n        'PGDAS' AS fonte\\r\\n    FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\n    WHERE nu_per_ref >= 202001\\r\\n      AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n    GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n    \\r\\n    UNION ALL\\r\\n    \\r\\n    -- DIME: agregar por CNPJ_RAIZ\\r\\n    SELECT \\r\\n        nu_cnpj_grupo AS cnpj_raiz,\\r\\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(vl_receita_bruta, 0)) AS receita_bruta,\\r\\n        'DIME' AS fonte\\r\\n    FROM usr_sat_ods.ods_decl_dime_raw\\r\\n    WHERE nu_per_ref >= 202001\\r\\n      AND COALESCE(sn_cancelada, 0) = 0\\r\\n      AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\\r\\n    GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n) fat\\r\\nGROUP BY cnpj_raiz, ano;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_09b_receita_anual_corrigida;\", \"\\r\\n\\r\\n-- Verificar se ainda h\\u00e1 duplicatas\\r\\nSELECT 'Duplicatas ap\\u00f3s corre\\u00e7\\u00e3o' AS check_type, COUNT(*) AS qtd\\r\\nFROM (\\r\\n    SELECT cnpj_raiz, ano, COUNT(*) AS c\\r\\n    FROM gessimples.bcad_09b_receita_anual_corrigida\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n    HAVING COUNT(*) > 1\\r\\n) dup;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 10B: RECEITA GLOBAL - APENAS EMPRESAS SIMPLES NACIONAL\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00c3O PRINCIPAL: Soma apenas receita de empresas NO Simples Nacional\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_10b_receita_global_sn;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_10b_receita_global_sn AS\\r\\nSELECT \\r\\n    p.cpf_socio,\\r\\n    p.tipo_inciso,\\r\\n    r.ano,\\r\\n    -- Soma apenas empresas SN\\r\\n    SUM(r.receita_bruta_anual) AS receita_bruta_global_sn,\\r\\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_sn_com_faturamento,\\r\\n    CASE \\r\\n        WHEN SUM(r.receita_bruta_anual) > 5720000 THEN 'EXCESSO_20PCT'\\r\\n        WHEN SUM(r.receita_bruta_anual) > 4800000 THEN 'ACIMA_LIMITE'\\r\\n        ELSE 'DENTRO_LIMITE'\\r\\n    END AS situacao_limite,\\r\\n    5720000 - SUM(r.receita_bruta_anual) AS margem_excesso_20pct,\\r\\n    4800000 - SUM(r.receita_bruta_anual) AS margem_limite_normal\\r\\nFROM \\r\\n    (SELECT DISTINCT cpf_socio, tipo_inciso, cnpj_raiz \\r\\n     FROM gessimples.bcad_06_participacoes_grupos\\r\\n     WHERE flag_simples_nacional = 1  -- APENAS EMPRESAS SN\\r\\n    ) p\\r\\nINNER JOIN \\r\\n    gessimples.bcad_09b_receita_anual_corrigida r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz\\r\\nGROUP BY \\r\\n    p.cpf_socio, p.tipo_inciso, r.ano;\", \"\\r\\n\\r\\nCOMPUTE STATS gessimples.bcad_10b_receita_global_sn;\", \"\\r\\n\\r\\n-- Estat\\u00edsticas\\r\\nSELECT \\r\\n    'Receita Global SN' AS tabela,\\r\\n    COUNT(*) AS registros,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs,\\r\\n    SUM(CASE WHEN situacao_limite != 'DENTRO_LIMITE' THEN 1 ELSE 0 END) AS violacoes\\r\\nFROM gessimples.bcad_10b_receita_global_sn;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 11B: RECEITA ACUMULADA MENSAL - APENAS SN\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_11b_receita_acumulada_sn;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_11b_receita_acumulada_sn AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    mes,\\r\\n    periodo_apuracao,\\r\\n    receita_mensal_grupo,\\r\\n    SUM(receita_mensal_grupo) OVER (\\r\\n        PARTITION BY cpf_socio, ano \\r\\n        ORDER BY periodo_apuracao \\r\\n        ROWS UNBOUNDED PRECEDING\\r\\n    ) AS receita_acumulada_ano\\r\\nFROM (\\r\\n    SELECT \\r\\n        p.cpf_socio,\\r\\n        CAST(SUBSTR(CAST(f.periodo_apuracao AS STRING), 1, 4) AS INT) AS ano,\\r\\n        CAST(SUBSTR(CAST(f.periodo_apuracao AS STRING), 5, 2) AS INT) AS mes,\\r\\n        f.periodo_apuracao,\\r\\n        SUM(f.receita_bruta) AS receita_mensal_grupo\\r\\n    FROM \\r\\n        (SELECT DISTINCT cpf_socio, cnpj_raiz \\r\\n         FROM gessimples.bcad_06_participacoes_grupos\\r\\n         WHERE flag_simples_nacional = 1  -- APENAS EMPRESAS SN\\r\\n        ) p\\r\\n    INNER JOIN (\\r\\n        -- PGDAS agregado\\r\\n        SELECT \\r\\n            nu_cnpj_grupo AS cnpj_raiz,\\r\\n            nu_per_ref AS periodo_apuracao,\\r\\n            SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta\\r\\n        FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\n        WHERE nu_per_ref >= 202001\\r\\n          AND nu_cnpj_grupo IN (\\r\\n              SELECT DISTINCT cnpj_raiz \\r\\n              FROM gessimples.bcad_06_participacoes_grupos\\r\\n              WHERE flag_simples_nacional = 1\\r\\n          )\\r\\n        GROUP BY nu_cnpj_grupo, nu_per_ref\\r\\n    ) f ON p.cnpj_raiz = f.cnpj_raiz\\r\\n    GROUP BY p.cpf_socio, f.periodo_apuracao\\r\\n) sub;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 5: CORRE\\u00c7\\u00d5ES APLICADAS\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00d5ES:\\r\\n-- 1. Receita global considera apenas empresas do Simples Nacional\\r\\n-- 2. Removidas duplicatas na receita anual (agrega\\u00e7\\u00e3o por CNPJ+ano)\\r\\n-- 3. DISTINCT na tabela final de viola\\u00e7\\u00f5es\\r\\n-- 4. Filtro para excluir empresas de capital aberto (natureza jur\\u00eddica)\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"a447886a-f4a8-4d91-e55b-7b874e54f3e5\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"GD/4hgsCT6qf84dmlLNNMw==\", \"guid\": \"/gEBfXYUQYcAAAAA0v/Hpw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3e4a48a3a838dbc4:71bc5146f6698381\", \"session_id\": 23528, \"session_type\": \"impala\", \"statement_id\": 28, \"has_more_statements\": false, \"statements_count\": 29, \"previous_statement_hash\": \"a6112e1d376d50ac7f449de7f13be75d0d2ab410243e41833396c0be\", \"start\": {\"row\": 431, \"column\": 0}, \"end\": {\"row\": 440, \"column\": 22}, \"statement\": \"-- Por tipo de inciso\\nSELECT \\n    tipo_inciso,\\n    COUNT(*) AS qtd_violacoes,\\n    COUNT(DISTINCT cpf_socio) AS cpfs_distintos,\\n    AVG(receita_bruta_global_sn) AS media_receita,\\n    MAX(receita_bruta_global_sn) AS max_receita\\nFROM gessimples.bcad_13b_violacoes_final_sn\\nGROUP BY tipo_inciso\\nORDER BY COUNT(*) DESC\"}, \"meta\": [], \"rows\": 3, \"hasMore\": false, \"statement_id\": 28, \"statement_range\": {\"start\": {\"row\": 431, \"column\": 0}, \"end\": {\"row\": 440, \"column\": 22}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-12-04T19:37:53.484Z\", \"endTime\": \"2025-12-04T19:37:53.671Z\", \"executionTime\": 187, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"cpfs_distintos\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"cpfs_distintos\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764877073274, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 239, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- PROJETO GENESIS - Versão 5: CORREÇÕES APLICADAS\r\n-- ============================================================================\r\n-- CORREÇÕES:\r\n-- 1. Receita global considera apenas empresas do Simples Nacional\r\n-- 2. Removidas duplicatas na receita anual (agregação por CNPJ+ano)\r\n-- 3. DISTINCT na tabela final de violações\r\n-- 4. Filtro para excluir empresas de capital aberto (natureza jurídica)\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- ETAPA 9B: RECEITA ANUAL - CORRIGIDA (sem duplicatas)\r\n-- ============================================================================\r\n-- Problema: mesmo CNPJ pode ter múltiplos registros por ter filiais\r\n\r\nDROP TABLE IF EXISTS gessimples.bcad_09b_receita_anual_corrigida;\r\n\r\nCREATE TABLE gessimples.bcad_09b_receita_anual_corrigida AS\r\nSELECT \r\n    cnpj_raiz,\r\n    ano,\r\n    SUM(receita_bruta) AS receita_bruta_anual,\r\n    COUNT(DISTINCT periodo_apuracao) AS qtd_periodos,\r\n    MAX(fonte) AS fonte_principal\r\nFROM (\r\n    -- PGDAS: agregar por CNPJ_RAIZ (não por estabelecimento)\r\n    SELECT \r\n        nu_cnpj_grupo AS cnpj_raiz,\r\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\r\n        nu_per_ref AS periodo_apuracao,\r\n        SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta,\r\n        'PGDAS' AS fonte\r\n    FROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\r\n    WHERE nu_per_ref >= 202001\r\n      AND nu_cnpj_grupo IN (SELECT DISTINCT cnpj_raiz FROM gessimples.bcad_06_participacoes_grupos)\r\n    GROUP BY nu_cnpj_grupo, nu_per_ref\r\n    \r\n    UNION ALL\r\n    \r\n    -- DIME: agregar por CNPJ_RAIZ\r\n    SELECT \r\n        nu_cnpj_grupo AS cnpj_raiz,\r\n        CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\r\n        nu_per_ref AS periodo_apuracao,\r\n        SUM(COALESCE(vl_receita",
    "last_modified": "2026-01-05T15:39:40.716",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "0ecc1bc7-7639-4257-85c5-678adbb678b9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 186676,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCAD 03",
    "description": "",
    "uuid": "6b5a9790-f47f-e37a-331c-63e2099e75fd",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 186676, \"uuid\": \"6b5a9790-f47f-e37a-331c-63e2099e75fd\", \"name\": \"BCAD 03\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"8cad00a1-0027-bc2c-28da-021fb4326018\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 6: APENAS PGDAS (fonte correta para SN)\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00c3O PRINCIPAL:\\r\\n-- - Empresas no Simples Nacional declaram via PGDAS-D, N\\u00c3O via DIME\\r\\n-- - Se empresa declara na DIME, ela N\\u00c3O est\\u00e1 no Simples Nacional\\r\\n-- - Usar apenas PGDAS como fonte de receita elimina falsos positivos\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 9C: RECEITA ANUAL - APENAS PGDAS (fonte correta para SN)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_09c_receita_anual_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_09c_receita_anual_pgdas AS\\r\\nSELECT \\r\\n    nu_cnpj_grupo AS cnpj_raiz,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n    SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta_anual,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtd_periodos,\\r\\n    'PGDAS' AS fonte_principal\\r\\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\nWHERE nu_per_ref >= 202001\\r\\n  AND nu_cnpj_grupo IN (\\r\\n      SELECT DISTINCT cnpj_raiz \\r\\n      FROM gessimples.bcad_06_participacoes_grupos\\r\\n      WHERE flag_simples_nacional = 1\\r\\n  )\\r\\nGROUP BY nu_cnpj_grupo, CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT);\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 10C: RECEITA GLOBAL - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_10c_receita_global_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_10c_receita_global_pgdas AS\\r\\nSELECT \\r\\n    p.cpf_socio,\\r\\n    p.tipo_inciso,\\r\\n    r.ano,\\r\\n    SUM(r.receita_bruta_anual) AS receita_bruta_global,\\r\\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_com_faturamento,\\r\\n    CASE \\r\\n        WHEN SUM(r.receita_bruta_anual) > 5720000 THEN 'EXCESSO_20PCT'\\r\\n        WHEN SUM(r.receita_bruta_anual) > 4800000 THEN 'ACIMA_LIMITE'\\r\\n        ELSE 'DENTRO_LIMITE'\\r\\n    END AS situacao_limite,\\r\\n    5720000 - SUM(r.receita_bruta_anual) AS margem_excesso_20pct,\\r\\n    4800000 - SUM(r.receita_bruta_anual) AS margem_limite_normal\\r\\nFROM \\r\\n    (SELECT DISTINCT cpf_socio, tipo_inciso, cnpj_raiz \\r\\n     FROM gessimples.bcad_06_participacoes_grupos\\r\\n     WHERE flag_simples_nacional = 1\\r\\n    ) p\\r\\nINNER JOIN \\r\\n    gessimples.bcad_09c_receita_anual_pgdas r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz\\r\\nGROUP BY \\r\\n    p.cpf_socio, p.tipo_inciso, r.ano;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 11C: RECEITA ACUMULADA MENSAL - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_11c_receita_acumulada_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_11c_receita_acumulada_pgdas AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    mes,\\r\\n    periodo_apuracao,\\r\\n    receita_mensal_grupo,\\r\\n    SUM(receita_mensal_grupo) OVER (\\r\\n        PARTITION BY cpf_socio, ano \\r\\n        ORDER BY periodo_apuracao \\r\\n        ROWS UNBOUNDED PRECEDING\\r\\n    ) AS receita_acumulada_ano\\r\\nFROM (\\r\\n    SELECT \\r\\n        p.cpf_socio,\\r\\n        CAST(SUBSTR(CAST(pg.nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        CAST(SUBSTR(CAST(pg.nu_per_ref AS STRING), 5, 2) AS INT) AS mes,\\r\\n        pg.nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(pg.vl_rec_bruta_estab, 0)) AS receita_mensal_grupo\\r\\n    FROM \\r\\n        (SELECT DISTINCT cpf_socio, cnpj_raiz \\r\\n         FROM gessimples.bcad_06_participacoes_grupos\\r\\n         WHERE flag_simples_nacional = 1\\r\\n        ) p\\r\\n    INNER JOIN usr_sat_ods.sna_pgdasd_estabelecimento_raw pg\\r\\n        ON pg.nu_cnpj_grupo = p.cnpj_raiz\\r\\n    WHERE pg.nu_per_ref >= 202001\\r\\n    GROUP BY p.cpf_socio, pg.nu_per_ref\\r\\n) sub;\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 12C: M\\u00caS DO ESTOURO - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_12c_mes_estouro_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_12c_mes_estouro_pgdas AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    receita_final_ano,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN 'EXCESSO_20PCT_MES_SEGUINTE'\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN 'ACIMA_LIMITE_JANEIRO_SEGUINTE'\\r\\n        ELSE NULL\\r\\n    END AS tipo_exclusao,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN \\r\\n            CAST(\\r\\n                CONCAT(\\r\\n                    CASE \\r\\n                        WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 \\r\\n                        THEN CAST(CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4) AS INT) + 1 AS STRING)\\r\\n                        ELSE SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4)\\r\\n                    END,\\r\\n                    LPAD(\\r\\n                        CAST(\\r\\n                            CASE \\r\\n                                WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 THEN 1\\r\\n                                ELSE CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) + 1\\r\\n                            END \\r\\n                        AS STRING), \\r\\n                        2, '0'\\r\\n                    )\\r\\n                ) AS INT\\r\\n            )\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN \\r\\n            CAST(CONCAT(CAST(ano + 1 AS STRING), '01') AS INT)\\r\\n        ELSE NULL\\r\\n    END AS periodo_exclusao\\r\\nFROM (\\r\\n    SELECT \\r\\n        cpf_socio,\\r\\n        ano,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN periodo_apuracao END) AS periodo_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN receita_acumulada_ano END) AS valor_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN periodo_apuracao END) AS periodo_estouro_limite,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN receita_acumulada_ano END) AS valor_estouro_limite,\\r\\n        MAX(receita_acumulada_ano) AS receita_final_ano\\r\\n    FROM gessimples.bcad_11c_receita_acumulada_pgdas\\r\\n    GROUP BY cpf_socio, ano\\r\\n) primeiro_estouro\\r\\nWHERE periodo_estouro_20pct IS NOT NULL OR periodo_estouro_limite IS NOT NULL;\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 13C: RESULTADO FINAL - VIOLA\\u00c7\\u00d5ES (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_13c_violacoes_final_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_13c_violacoes_final_pgdas AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global,\\r\\n    qtd_empresas_com_faturamento,\\r\\n    situacao_limite,\\r\\n    margem_excesso_20pct,\\r\\n    margem_limite_normal,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_total,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas,\\r\\n    dt_processamento\\r\\nFROM (\\r\\n    SELECT \\r\\n        DENSE_RANK() OVER (ORDER BY rg.receita_bruta_global DESC, rg.cpf_socio) AS num_grupo,\\r\\n        rg.cpf_socio,\\r\\n        cpf.nomecontribuinte AS nome_socio,\\r\\n        rg.tipo_inciso,\\r\\n        rg.ano AS ano_apuracao,\\r\\n        rg.receita_bruta_global,\\r\\n        rg.qtd_empresas_com_faturamento,\\r\\n        rg.situacao_limite,\\r\\n        rg.margem_excesso_20pct,\\r\\n        rg.margem_limite_normal,\\r\\n        me.periodo_estouro_20pct,\\r\\n        me.valor_estouro_20pct,\\r\\n        me.periodo_estouro_limite,\\r\\n        me.valor_estouro_limite,\\r\\n        me.tipo_exclusao,\\r\\n        me.periodo_exclusao,\\r\\n        g.qtd_empresas_total,\\r\\n        g.qtd_empresas_sn,\\r\\n        g.qtd_empresas_normal,\\r\\n        g.ufs_empresas,\\r\\n        NOW() AS dt_processamento,\\r\\n        ROW_NUMBER() OVER (PARTITION BY rg.cpf_socio, rg.ano ORDER BY rg.receita_bruta_global DESC) AS rn\\r\\n    FROM \\r\\n        gessimples.bcad_10c_receita_global_pgdas rg\\r\\n    INNER JOIN \\r\\n        gessimples.bcad_05_cpfs_multiplas_empresas g \\r\\n        ON rg.cpf_socio = g.cpf_socio\\r\\n    LEFT JOIN \\r\\n        gessimples.bcad_12c_mes_estouro_pgdas me \\r\\n        ON rg.cpf_socio = me.cpf_socio AND rg.ano = me.ano\\r\\n    LEFT JOIN \\r\\n        bcadastro.cpf cpf \\r\\n        ON rg.cpf_socio = cpf.cpfid\\r\\n    WHERE \\r\\n        rg.situacao_limite IN ('EXCESSO_20PCT', 'ACIMA_LIMITE')\\r\\n) ranked\\r\\nWHERE rn = 1;\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 14C: DETALHE POR EMPRESA (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_14c_violacoes_detalhe_pgdas;\\r\\n\\r\\nCREATE TABLE gessimples.bcad_14c_violacoes_detalhe_pgdas AS\\r\\nSELECT DISTINCT\\r\\n    v.num_grupo,\\r\\n    v.cpf_socio,\\r\\n    v.nome_socio,\\r\\n    v.tipo_inciso,\\r\\n    v.ano_apuracao,\\r\\n    v.receita_bruta_global AS receita_global_grupo,\\r\\n    v.situacao_limite,\\r\\n    v.tipo_exclusao,\\r\\n    v.periodo_exclusao,\\r\\n    p.cnpj_raiz,\\r\\n    p.cnpj_completo,\\r\\n    p.razao_social,\\r\\n    p.uf,\\r\\n    p.regime_tributacao,\\r\\n    p.flag_simples_nacional,\\r\\n    p.perc_participacao,\\r\\n    p.flag_maior_10pct,\\r\\n    p.fonte AS fonte_dados,\\r\\n    COALESCE(r.receita_bruta_anual, 0) AS receita_bruta_empresa,\\r\\n    r.qtd_periodos AS periodos_declarados\\r\\nFROM \\r\\n    gessimples.bcad_13c_violacoes_final_pgdas v\\r\\nINNER JOIN \\r\\n    gessimples.bcad_06_participacoes_grupos p \\r\\n    ON v.cpf_socio = p.cpf_socio\\r\\nLEFT JOIN \\r\\n    gessimples.bcad_09c_receita_anual_pgdas r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz AND v.ano_apuracao = r.ano;\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- VIEWS V6\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v6_resumo;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v6_resumo AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global,\\r\\n    situacao_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas\\r\\nFROM gessimples.bcad_13c_violacoes_final_pgdas;\\r\\n\\r\\n\\r\\nDROP VIEW IF EXISTS gessimples.vw_bcad_v6_estatisticas;\\r\\n\\r\\nCREATE VIEW gessimples.vw_bcad_v6_estatisticas AS\\r\\nSELECT \\r\\n    ano_apuracao,\\r\\n    tipo_inciso,\\r\\n    situacao_limite,\\r\\n    COUNT(*) AS qtd_grupos,\\r\\n    COUNT(DISTINCT cpf_socio) AS qtd_socios,\\r\\n    SUM(receita_bruta_global) AS soma_receita,\\r\\n    AVG(receita_bruta_global) AS media_receita,\\r\\n    MIN(receita_bruta_global) AS min_receita,\\r\\n    MAX(receita_bruta_global) AS max_receita\\r\\nFROM gessimples.bcad_13c_violacoes_final_pgdas\\r\\nGROUP BY ano_apuracao, tipo_inciso, situacao_limite;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- COMPARATIVO V4 vs V5 vs V6\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT \\r\\n    'V4 Original (SN+Normal, PGDAS+DIME)' AS versao,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs_unicos,\\r\\n    MAX(receita_bruta_global) AS max_receita\\r\\nFROM gessimples.bcad_13_violacoes_final\\r\\nUNION ALL\\r\\nSELECT \\r\\n    'V5 Apenas SN (PGDAS+DIME)',\\r\\n    COUNT(*),\\r\\n    COUNT(DISTINCT cpf_socio),\\r\\n    MAX(receita_bruta_global_sn)\\r\\nFROM gessimples.bcad_13b_violacoes_final_sn\\r\\nUNION ALL\\r\\nSELECT \\r\\n    'V6 Apenas PGDAS',\\r\\n    COUNT(*),\\r\\n    COUNT(DISTINCT cpf_socio),\\r\\n    MAX(receita_bruta_global)\\r\\nFROM gessimples.bcad_13c_violacoes_final_pgdas;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- DISTRIBUI\\u00c7\\u00c3O POR FAIXA (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT \\r\\n    CASE \\r\\n        WHEN receita_bruta_global <= 4800000 THEN '1. At\\u00e9 4.8M'\\r\\n        WHEN receita_bruta_global <= 5720000 THEN '2. 4.8M - 5.72M'\\r\\n        WHEN receita_bruta_global <= 10000000 THEN '3. 5.72M - 10M'\\r\\n        WHEN receita_bruta_global <= 15000000 THEN '4. 10M - 15M'\\r\\n        WHEN receita_bruta_global <= 20000000 THEN '5. 15M - 20M'\\r\\n        ELSE '6. Acima 20M'\\r\\n    END AS faixa,\\r\\n    COUNT(*) AS qtd,\\r\\n    MIN(receita_bruta_global) AS min_val,\\r\\n    MAX(receita_bruta_global) AS max_val\\r\\nFROM gessimples.bcad_13c_violacoes_final_pgdas\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN receita_bruta_global <= 4800000 THEN '1. At\\u00e9 4.8M'\\r\\n        WHEN receita_bruta_global <= 5720000 THEN '2. 4.8M - 5.72M'\\r\\n        WHEN receita_bruta_global <= 10000000 THEN '3. 5.72M - 10M'\\r\\n        WHEN receita_bruta_global <= 15000000 THEN '4. 10M - 15M'\\r\\n        WHEN receita_bruta_global <= 20000000 THEN '5. 15M - 20M'\\r\\n        ELSE '6. Acima 20M'\\r\\n    END\\r\\nORDER BY 1;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TOP 20 VIOLA\\u00c7\\u00d5ES (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT * FROM gessimples.vw_bcad_v6_resumo \\r\\nORDER BY receita_bruta_global DESC \\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- POR TIPO DE INCISO (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT \\r\\n    tipo_inciso,\\r\\n    COUNT(*) AS qtd_violacoes,\\r\\n    COUNT(DISTINCT cpf_socio) AS cpfs_distintos,\\r\\n    AVG(receita_bruta_global) AS media_receita,\\r\\n    MAX(receita_bruta_global) AS max_receita\\r\\nFROM gessimples.bcad_13c_violacoes_final_pgdas\\r\\nGROUP BY tipo_inciso\\r\\nORDER BY COUNT(*) DESC;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 6: APENAS PGDAS (fonte correta para SN)\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00c3O PRINCIPAL:\\r\\n-- - Empresas no Simples Nacional declaram via PGDAS-D, N\\u00c3O via DIME\\r\\n-- - Se empresa declara na DIME, ela N\\u00c3O est\\u00e1 no Simples Nacional\\r\\n-- - Usar apenas PGDAS como fonte de receita elimina falsos positivos\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 9C: RECEITA ANUAL - APENAS PGDAS (fonte correta para SN)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_09c_receita_anual_pgdas;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_09c_receita_anual_pgdas AS\\r\\nSELECT \\r\\n    nu_cnpj_grupo AS cnpj_raiz,\\r\\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n    SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta_anual,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtd_periodos,\\r\\n    'PGDAS' AS fonte_principal\\r\\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\nWHERE nu_per_ref >= 202001\\r\\n  AND nu_cnpj_grupo IN (\\r\\n      SELECT DISTINCT cnpj_raiz \\r\\n      FROM gessimples.bcad_06_participacoes_grupos\\r\\n      WHERE flag_simples_nacional = 1\\r\\n  )\\r\\nGROUP BY nu_cnpj_grupo, CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT);\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 10C: RECEITA GLOBAL - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_10c_receita_global_pgdas;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_10c_receita_global_pgdas AS\\r\\nSELECT \\r\\n    p.cpf_socio,\\r\\n    p.tipo_inciso,\\r\\n    r.ano,\\r\\n    SUM(r.receita_bruta_anual) AS receita_bruta_global,\\r\\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_com_faturamento,\\r\\n    CASE \\r\\n        WHEN SUM(r.receita_bruta_anual) > 5720000 THEN 'EXCESSO_20PCT'\\r\\n        WHEN SUM(r.receita_bruta_anual) > 4800000 THEN 'ACIMA_LIMITE'\\r\\n        ELSE 'DENTRO_LIMITE'\\r\\n    END AS situacao_limite,\\r\\n    5720000 - SUM(r.receita_bruta_anual) AS margem_excesso_20pct,\\r\\n    4800000 - SUM(r.receita_bruta_anual) AS margem_limite_normal\\r\\nFROM \\r\\n    (SELECT DISTINCT cpf_socio, tipo_inciso, cnpj_raiz \\r\\n     FROM gessimples.bcad_06_participacoes_grupos\\r\\n     WHERE flag_simples_nacional = 1\\r\\n    ) p\\r\\nINNER JOIN \\r\\n    gessimples.bcad_09c_receita_anual_pgdas r \\r\\n    ON p.cnpj_raiz = r.cnpj_raiz\\r\\nGROUP BY \\r\\n    p.cpf_socio, p.tipo_inciso, r.ano;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 11C: RECEITA ACUMULADA MENSAL - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_11c_receita_acumulada_pgdas;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_11c_receita_acumulada_pgdas AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    mes,\\r\\n    periodo_apuracao,\\r\\n    receita_mensal_grupo,\\r\\n    SUM(receita_mensal_grupo) OVER (\\r\\n        PARTITION BY cpf_socio, ano \\r\\n        ORDER BY periodo_apuracao \\r\\n        ROWS UNBOUNDED PRECEDING\\r\\n    ) AS receita_acumulada_ano\\r\\nFROM (\\r\\n    SELECT \\r\\n        p.cpf_socio,\\r\\n        CAST(SUBSTR(CAST(pg.nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\\r\\n        CAST(SUBSTR(CAST(pg.nu_per_ref AS STRING), 5, 2) AS INT) AS mes,\\r\\n        pg.nu_per_ref AS periodo_apuracao,\\r\\n        SUM(COALESCE(pg.vl_rec_bruta_estab, 0)) AS receita_mensal_grupo\\r\\n    FROM \\r\\n        (SELECT DISTINCT cpf_socio, cnpj_raiz \\r\\n         FROM gessimples.bcad_06_participacoes_grupos\\r\\n         WHERE flag_simples_nacional = 1\\r\\n        ) p\\r\\n    INNER JOIN usr_sat_ods.sna_pgdasd_estabelecimento_raw pg\\r\\n        ON pg.nu_cnpj_grupo = p.cnpj_raiz\\r\\n    WHERE pg.nu_per_ref >= 202001\\r\\n    GROUP BY p.cpf_socio, pg.nu_per_ref\\r\\n) sub;\", \"\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 12C: M\\u00caS DO ESTOURO - APENAS PGDAS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_12c_mes_estouro_pgdas;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_12c_mes_estouro_pgdas AS\\r\\nSELECT \\r\\n    cpf_socio,\\r\\n    ano,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    receita_final_ano,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN 'EXCESSO_20PCT_MES_SEGUINTE'\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN 'ACIMA_LIMITE_JANEIRO_SEGUINTE'\\r\\n        ELSE NULL\\r\\n    END AS tipo_exclusao,\\r\\n    CASE \\r\\n        WHEN periodo_estouro_20pct IS NOT NULL THEN \\r\\n            CAST(\\r\\n                CONCAT(\\r\\n                    CASE \\r\\n                        WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 \\r\\n                        THEN CAST(CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4) AS INT) + 1 AS STRING)\\r\\n                        ELSE SUBSTR(CAST(periodo_estouro_20pct AS STRING), 1, 4)\\r\\n                    END,\\r\\n                    LPAD(\\r\\n                        CAST(\\r\\n                            CASE \\r\\n                                WHEN CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) = 12 THEN 1\\r\\n                                ELSE CAST(SUBSTR(CAST(periodo_estouro_20pct AS STRING), 5, 2) AS INT) + 1\\r\\n                            END \\r\\n                        AS STRING), \\r\\n                        2, '0'\\r\\n                    )\\r\\n                ) AS INT\\r\\n            )\\r\\n        WHEN periodo_estouro_limite IS NOT NULL THEN \\r\\n            CAST(CONCAT(CAST(ano + 1 AS STRING), '01') AS INT)\\r\\n        ELSE NULL\\r\\n    END AS periodo_exclusao\\r\\nFROM (\\r\\n    SELECT \\r\\n        cpf_socio,\\r\\n        ano,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN periodo_apuracao END) AS periodo_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 5720000 THEN receita_acumulada_ano END) AS valor_estouro_20pct,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN periodo_apuracao END) AS periodo_estouro_limite,\\r\\n        MIN(CASE WHEN receita_acumulada_ano > 4800000 THEN receita_acumulada_ano END) AS valor_estouro_limite,\\r\\n        MAX(receita_acumulada_ano) AS receita_final_ano\\r\\n    FROM gessimples.bcad_11c_receita_acumulada_pgdas\\r\\n    GROUP BY cpf_socio, ano\\r\\n) primeiro_estouro\\r\\nWHERE periodo_estouro_20pct IS NOT NULL OR periodo_estouro_limite IS NOT NULL;\", \"\\r\\n\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- ETAPA 13C: RESULTADO FINAL - VIOLA\\u00c7\\u00d5ES (V6)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS gessimples.bcad_13c_violacoes_final_pgdas;\", \"\\r\\n\\r\\nCREATE TABLE gessimples.bcad_13c_violacoes_final_pgdas AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    cpf_socio,\\r\\n    nome_socio,\\r\\n    tipo_inciso,\\r\\n    ano_apuracao,\\r\\n    receita_bruta_global,\\r\\n    qtd_empresas_com_faturamento,\\r\\n    situacao_limite,\\r\\n    margem_excesso_20pct,\\r\\n    margem_limite_normal,\\r\\n    periodo_estouro_20pct,\\r\\n    valor_estouro_20pct,\\r\\n    periodo_estouro_limite,\\r\\n    valor_estouro_limite,\\r\\n    tipo_exclusao,\\r\\n    periodo_exclusao,\\r\\n    qtd_empresas_total,\\r\\n    qtd_empresas_sn,\\r\\n    qtd_empresas_normal,\\r\\n    ufs_empresas,\\r\\n    dt_processamento\\r\\nFROM (\\r\\n    SELECT \\r\\n        DENSE_RANK() OVER (ORDER BY rg.receita_bruta_global DESC, rg.cpf_socio) AS num_grupo,\\r\\n        rg.cpf_socio,\\r\\n        cpf.nomecontribuinte AS nome_socio,\\r\\n        rg.tipo_inciso,\\r\\n        rg.ano AS ano_apuracao,\\r\\n        rg.receita_bruta_global,\\r\\n        rg.qtd_empresas_com_faturamento,\\r\\n        rg.situacao_limite,\\r\\n        rg.margem_excesso_20pct,\\r\\n        rg.margem_limite_normal,\\r\\n        me.periodo_estouro_20pct,\\r\\n        me.valor_estouro_20pct,\\r\\n        me.periodo_estouro_limite,\\r\\n        me.valor_estouro_limite,\\r\\n        me.tipo_exclusao,\\r\\n        me.periodo_exclusao,\\r\\n        g.qtd_empresas_total,\\r\\n        g.qtd_empresas_sn,\\r\\n        g.qtd_empresas_normal,\\r\\n        g.ufs_empresas,\\r\\n        NOW() AS dt_processamento,\\r\\n        ROW_NUMBER() OVER (PARTITION BY rg.cpf_socio, rg.ano ORDER BY rg.receita_bruta_global DESC) AS rn\\r\\n    FROM \\r\\n        gessimples.bcad_10c_receita_global_pgdas rg\\r\\n    INNER JOIN \\r\\n        gessimples.bcad_05_cpfs_multiplas_empresas g \\r\\n        ON rg.cpf_socio = g.cpf_socio\\r\\n    LEFT JOIN \\r\\n        gessimples.bcad_12c_mes_estouro_pgdas me \\r\\n        ON rg.cpf_socio = me.cpf_socio AND rg.ano = me.ano\\r\\n    LEFT JOIN \\r\\n        bcadastro.cpf cpf \\r\\n        ON rg.cpf_socio = cpf.cpfid\\r\\n    WHERE \\r\\n        rg.situacao_limite IN ('EXCESSO_20PCT', 'ACIMA_LIMITE')\\r\\n) ranked\\r\\nWHERE rn = 1;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- PROJETO GENESIS - Vers\\u00e3o 6: APENAS PGDAS (fonte correta para SN)\\r\\n-- ============================================================================\\r\\n-- CORRE\\u00c7\\u00c3O PRINCIPAL:\\r\\n-- - Empresas no Simples Nacional declaram via PGDAS-D, N\\u00c3O via DIME\\r\\n-- - Se empresa declara na DIME, ela N\\u00c3O est\\u00e1 no Simples Nacional\\r\\n-- - Usar apenas PGDAS como fonte de receita elimina falsos positivos\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"79fda876-11ea-785f-9359-7c0a5da2fcfd\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"GD/4hgsCT6qf84dmlLNNMw==\", \"guid\": \"UDGy7RGJTtwAAAAA15mmSw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"3e4a48a3a838dbc4:71bc5146f6698381\", \"session_id\": 23528, \"session_type\": \"impala\", \"statement_id\": 15, \"has_more_statements\": false, \"statements_count\": 16, \"previous_statement_hash\": \"2d8a5ef5bf209964fe5c5bfb0b9678a4c7baa0aaa898a6294a1e6fcc\", \"start\": {\"row\": 314, \"column\": 0}, \"end\": {\"row\": 326, \"column\": 22}, \"statement\": \"-- ============================================================================\\n-- POR TIPO DE INCISO (V6)\\n-- ============================================================================\\n\\nSELECT \\n    tipo_inciso,\\n    COUNT(*) AS qtd_violacoes,\\n    COUNT(DISTINCT cpf_socio) AS cpfs_distintos,\\n    AVG(receita_bruta_global) AS media_receita,\\n    MAX(receita_bruta_global) AS max_receita\\nFROM gessimples.bcad_13c_violacoes_final_pgdas\\nGROUP BY tipo_inciso\\nORDER BY COUNT(*) DESC\"}, \"meta\": [], \"rows\": 3, \"hasMore\": false, \"statement_id\": 15, \"statement_range\": {\"start\": {\"row\": 314, \"column\": 0}, \"end\": {\"row\": 326, \"column\": 22}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-12-04T19:57:34.690Z\", \"endTime\": \"2025-12-04T19:57:36.028Z\", \"executionTime\": 1338, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"cpfs_distintos\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"tipo_inciso\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"cpfs_distintos\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764878254444, \"lastAceSelectionRowOffset\": 63, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 239, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- PROJETO GENESIS - Versão 6: APENAS PGDAS (fonte correta para SN)\r\n-- ============================================================================\r\n-- CORREÇÃO PRINCIPAL:\r\n-- - Empresas no Simples Nacional declaram via PGDAS-D, NÃO via DIME\r\n-- - Se empresa declara na DIME, ela NÃO está no Simples Nacional\r\n-- - Usar apenas PGDAS como fonte de receita elimina falsos positivos\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- ETAPA 9C: RECEITA ANUAL - APENAS PGDAS (fonte correta para SN)\r\n-- ============================================================================\r\n\r\nDROP TABLE IF EXISTS gessimples.bcad_09c_receita_anual_pgdas;\r\n\r\nCREATE TABLE gessimples.bcad_09c_receita_anual_pgdas AS\r\nSELECT \r\n    nu_cnpj_grupo AS cnpj_raiz,\r\n    CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT) AS ano,\r\n    SUM(COALESCE(vl_rec_bruta_estab, 0)) AS receita_bruta_anual,\r\n    COUNT(DISTINCT nu_per_ref) AS qtd_periodos,\r\n    'PGDAS' AS fonte_principal\r\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\r\nWHERE nu_per_ref >= 202001\r\n  AND nu_cnpj_grupo IN (\r\n      SELECT DISTINCT cnpj_raiz \r\n      FROM gessimples.bcad_06_participacoes_grupos\r\n      WHERE flag_simples_nacional = 1\r\n  )\r\nGROUP BY nu_cnpj_grupo, CAST(SUBSTR(CAST(nu_per_ref AS STRING), 1, 4) AS INT);\r\n\r\n-- ============================================================================\r\n-- ETAPA 10C: RECEITA GLOBAL - APENAS PGDAS\r\n-- ============================================================================\r\n\r\nDROP TABLE IF EXISTS gessimples.bcad_10c_receita_global_pgdas;\r\n\r\nCREATE TABLE gessimples.bcad_10c_receita_global_pgdas AS\r\nSELECT \r\n    p.cpf_socio,\r\n    p.tipo_inciso,\r\n    r.ano,\r\n    SUM(r.receita_bruta_anual) AS receita_bruta_global,\r\n    COUNT(DISTINCT r.cnpj_raiz) AS qtd_empresas_c",
    "last_modified": "2026-01-05T15:39:44.614",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "0ecc1bc7-7639-4257-85c5-678adbb678b9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 186677,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCAD 2026",
    "description": "",
    "uuid": "0ecc1bc7-7639-4257-85c5-678adbb678b9",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2026-01-05T15:39:52.308",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
}
]
